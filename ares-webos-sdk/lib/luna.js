var npmlog=require("npmlog"),Eof=require("./eof");
(function(){var b=npmlog;b.heading="luna";b.level="http";var k={send:function(c,d,l,k,g){function n(e){f+=e;try{b.verbose("luna#send()","JSON line:",f),a=JSON.parse(f),f="",b.verbose("luna#send()","JSON object:",a),!1===a.returnValue?(h.destroy(),g(Error("luna-send command failed"+(a.errorText?" ("+a.errorText+")":a.errorMessage?" ("+a.errorMessage+")":"")))):k(a,function(e,a){b.verbose("luna#send()","err:",e,"value:",a);if(e||a)b.verbose("luna#send()","closing exec stream"),g(e,a)})}catch(p){}}var m=
c&&c.session,h=new Eof,a;h.pause();d=["luna:/",d.service,d.folder,d.method].join("/");b.verbose("luna#send()","calling:",d+" '"+JSON.stringify(l)+"'");c=c&&c.nReplies?"-n "+c.nReplies+" ":"-i ";m.run(m.getDevice().lunaSend+" "+c+d+" '"+JSON.stringify(l)+"'",h,function(a){(Buffer.isBuffer(a)?a.toString():a).split(/\r?\n/).forEach(n)},process.stderr,function(a){a&&g(a)});var f=""}};"undefined"!==typeof module&&module.exports&&(module.exports=k)})();
